# Mini App - –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

## ‚úÖ –ß—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. **–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è Remnawave API (–±–µ–∑ +00:00Z –¥—É–±–ª–∏–∫–∞—Ç–∞)
2. **sqlite3.Row** - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ dict –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `.get()`
3. **–í–µ–±—Ö—É–∫–∏ YooKassa** - –¥–æ–±–∞–≤–ª–µ–Ω—ã GET –∏ POST —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
4. **–û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Å—ã–ª–æ–∫** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Telegram.WebApp.openLink()`
5. **–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ API** - Caddy –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç `/api/*` –∏ `/webhook/*`
6. **–ü–æ—Ä—Ç 8080** - –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ Caddy

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
cd /opt/shftsecurebot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
curl https://app.shftsecure.one/
curl https://app.shftsecure.one/api/profile
curl https://app.shftsecure.one/webhook/yookassa

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
netstat -tlnp | grep 8080
netstat -tlnp | grep 443

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker compose logs bot --tail=50
docker compose logs -f bot | grep -i "mini app\|webhook"
```

## üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Mini App

### 1. Dashboard (–ì–ª–∞–≤–Ω–∞—è)

**–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏:**
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏"
- [ ] –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
- [ ] –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã

**–° –ø–æ–¥–ø–∏—Å–∫–æ–π:**
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞"
- [ ] –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- [ ] –ö–Ω–æ–ø–∫–∞ "–ö–æ–Ω—Ñ–∏–≥" –∫–æ–ø–∏—Ä—É–µ—Ç subscription URL
- [ ] –ö–Ω–æ–ø–∫–∞ "QR-–∫–æ–¥" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç QR-–∫–æ–¥
- [ ] –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å" –¥–µ–ª–∏—Ç—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π

### 2. Shop (–ú–∞–≥–∞–∑–∏–Ω)

- [ ] –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ —Ç–∞—Ä–∏—Ñ—ã (1–º, 3–º, 6–º, 12–º)
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–∫–∏–¥–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
- [ ] –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (Stars, –°–ë–ü, –ö–∞—Ä—Ç–∞)
- [ ] –ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] –¶–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å —É—á—ë—Ç–æ–º —Å–∫–∏–¥–∫–∏

### 3. Loyalty (–°—Ç–∞—Ç—É—Å)

- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å (Bronze/Silver/Gold/Platinum)
- [ ] –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –±–∞–ª–ª—ã
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
- [ ] –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
- [ ] –¢–∞–±–ª–∏—Ü–∞ —Ü–µ–Ω —Å —É—á—ë—Ç–æ–º —Å–∫–∏–¥–∫–∏

### 4. Gifts (–ü–æ–¥–∞—Ä–∫–∏)

**–í–∫–ª–∞–¥–∫–∞ "–ö—É–ø–∏—Ç—å":**
- [ ] –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ö–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫" —Ä–∞–±–æ—Ç–∞–µ—Ç

**–í–∫–ª–∞–¥–∫–∞ "–ú–æ–∏":**
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫—É–ø–ª–µ–Ω–Ω—ã–µ –∫–æ–¥—ã
- [ ] –ú–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
- [ ] –í–∏–¥–Ω–æ —Å—Ç–∞—Ç—É—Å (–∞–∫—Ç–∏–≤–µ–Ω/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)

**–í–∫–ª–∞–¥–∫–∞ "–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ":**
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏
- [ ] –í–∏–¥–Ω–∞ –¥–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è:**
- [ ] –ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–¥
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ –µ—Å–ª–∏ –∫–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π
- [ ] –£—Å–ø–µ—à–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É

### 5. History (–ò—Å—Ç–æ—Ä–∏—è)

- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏
- [ ] –§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç (–í—Å–µ/–ü–æ–¥–ø–∏—Å–∫–∏/–ü–æ–¥–∞—Ä–∫–∏)
- [ ] –í–∏–¥–Ω—ã —Å—É–º–º—ã, –¥–∞—Ç—ã, —Å—Ç–∞—Ç—É—Å—ã
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ" –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è

### 6. Support (–ü–æ–º–æ—â—å)

- [ ] –ö–Ω–æ–ø–∫–∞ "–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç @shftsup_bot
- [ ] –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] FAQ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è

## üîî –í–µ–±—Ö—É–∫–∏ YooKassa

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ YooKassa
1. –ó–∞–π—Ç–∏ –≤ https://yookassa.ru/my/merchant/integration/http-notifications
2. –î–æ–±–∞–≤–∏—Ç—å URL: `https://app.shftsecure.one/webhook/yookassa`
3. –í—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞
- [ ] –í–µ–±—Ö—É–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ YooKassa
- [ ] –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (1-2 —Å–µ–∫)
- [ ] –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ: "YooKassa webhook received: payment.succeeded"
- [ ] –ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: "Unexpected token '<' "<!DOCTYPE"... is not valid JSON"
**–ü—Ä–∏—á–∏–Ω–∞:** API –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∞—é—Ç HTML –≤–º–µ—Å—Ç–æ JSON
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ handle –≤ Caddyfile - `/api/*` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ç–∏–∫–æ–π

### –ü—Ä–æ–±–ª–µ–º–∞: 404 –Ω–∞ /api/profile
**–ü—Ä–∏—á–∏–Ω–∞:** –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª Mini App —Å–µ—Ä–≤–µ—Ä
**–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `WEBAPP_ENABLED=true` –≤ `.env` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

### –ü—Ä–æ–±–ª–µ–º–∞: "Invalid date format" –≤ –ª–æ–≥–∞—Ö
**–ü—Ä–∏—á–∏–Ω–∞:** –î–∞—Ç–∞ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç `2026-03-25T08:21:28+00:00Z`
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `to_utc_iso()` –∏–∑ `src.utils.datetime_utils`

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–Ω–æ–ø–∫–∏ –≤ Dashboard –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
**–ü—Ä–∏—á–∏–Ω–∞:** `subscriptionUrl` –ø—É—Å—Ç–æ–π –∏–ª–∏ null
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –≤ Remnawave –∏ –∏–º–µ–µ—Ç `shortUuid`

### –ü—Ä–æ–±–ª–µ–º–∞: –û–ø–ª–∞—Ç–∞ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `window.open()` –≤–º–µ—Å—Ç–æ Telegram API
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `window.Telegram.WebApp.openLink()`

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Mini App —Å–µ—Ä–≤–µ—Ä
docker compose logs bot | grep "Mini App server"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ–±—Ö—É–∫–∏
docker compose logs bot | grep -i yookassa | tail -20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
docker compose exec -T bot python3 << 'EOF'
from src.database import BotUser
user = BotUser.get_or_create(TELEGRAM_ID, None)
print(f"UUID: {user.get('remnawave_user_uuid')}")
print(f"Points: {user.get('loyalty_points')}")
EOF

# –ü–æ–ª–Ω—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç
cd /opt/shftsecurebot
docker compose down
git pull
docker compose build
docker compose up -d
cd caddy && docker compose restart
```

## ‚ú® –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

- ‚úÖ Frontend —Å–æ–±—Ä–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Backend API –∑–∞–ø—É—â–µ–Ω
- ‚úÖ Caddy –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –í–µ–±—Ö—É–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ –û–ø–ª–∞—Ç–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –û—Ç–∫—Ä–æ–π—Ç–µ Mini App –∏ –ø—Ä–æ–π–¥–∏—Ç–µ—Å—å –ø–æ –≤—Å–µ–º —Ä–∞–∑–¥–µ–ª–∞–º!


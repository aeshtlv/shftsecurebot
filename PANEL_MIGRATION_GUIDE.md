# üöö –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å Remnawave

## üìã –°—Ü–µ–Ω–∞—Ä–∏–π

–í—ã —Å–æ–∑–¥–∞—ë—Ç–µ **–Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å Remnawave** –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ —Å –Ω–æ–≤—ã–º –¥–æ–º–µ–Ω–æ–º, –∏ –Ω—É–∂–Ω–æ:
1. ‚úÖ –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Å—Ä–æ–∫–∏
3. ‚úÖ –í—ã–¥–∞—Ç—å –Ω–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
4. ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å

### –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–æ—Ç–µ:
```
bot_users:
  telegram_id: 123456789
  username: "user123"
  remnawave_user_uuid: "abc-123-def-456"  ‚Üê UUID –∏–∑ —Å—Ç–∞—Ä–æ–π –ø–∞–Ω–µ–ª–∏
  loyalty_points: 500
  trial_used: true
```

### –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–Ω–µ–ª–∏ Remnawave:
```
users:
  uuid: "abc-123-def-456"  ‚Üê –≠—Ç–æ—Ç UUID —Å–æ–∑–¥–∞—ë—Ç –ø–∞–Ω–µ–ª—å
  username: "user123"
  telegram_id: 123456789
  expire_at: "2026-03-01T00:00:00Z"
  subscriptionUrl: "https://panel.old-domain.com/api/sub/SHORT_UUID"
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ **–Ω–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏** —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥—É—Ç **–Ω–æ–≤—ã–µ UUID**, –∏ –±–æ—Ç –ø–æ—Ç–µ—Ä—è–µ—Ç —Å–≤—è–∑—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏!

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç A: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ü–ª—é—Å—ã:**
- ‚úÖ –ú–∏–Ω–∏–º—É–º —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–æ–Ω—Ñ–∏–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ë–æ—Ç —Å–∞–º –æ–±–Ω–æ–≤–ª—è–µ—Ç UUID

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ö†Ô∏è –ù—É–∂–µ–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UUID –≤ –±–∞–∑–µ –±–æ—Ç–∞

---

### –í–∞—Ä–∏–∞–Ω—Ç B: –†—É—á–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–ü—Ä–æ—Å—Ç–∞—è)

**–ü–ª—é—Å—ã:**
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–∫—Ä–∏–ø—Ç–æ–≤
- ‚úÖ –õ–µ–≥–∫–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–Ω–æ–≤–æ "–∫—É–ø–∏—Ç—å" –ø–æ–¥–ø–∏—Å–∫—É (–º–æ–∂–Ω–æ –¥–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- ‚ùå –ü–æ—Ç–µ—Ä—è –∏—Å—Ç–æ—Ä–∏–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ë–î)

---

## üìù –í–∞—Ä–∏–∞–Ω—Ç A: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

### –®–∞–≥ 1: –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Å—Ç–∞—Ä–æ–π –ø–∞–Ω–µ–ª–∏

**–ß–µ—Ä–µ–∑ API —Å—Ç–∞—Ä–æ–π –ø–∞–Ω–µ–ª–∏:**

```bash
#!/bin/bash
# export_users.sh

OLD_PANEL="https://panel.old-domain.com"
API_TOKEN="your_old_api_token"

curl -X GET "$OLD_PANEL/api/users?start=0&size=1000" \
  -H "Authorization: Bearer $API_TOKEN" \
  -o users_export.json

echo "‚úÖ Exported users to users_export.json"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∞–π–ª `users_export.json` —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

---

### –®–∞–≥ 2: –ò–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å

**–°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–º–ø–æ—Ä—Ç–∞:**

```python
#!/usr/bin/env python3
# import_users.py

import json
import httpx
from datetime import datetime

OLD_PANEL = "https://panel.old-domain.com"
NEW_PANEL = "https://panel.new-domain.com"
NEW_API_TOKEN = "your_new_api_token"

# –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
with open("users_export.json", "r") as f:
    data = json.load(f)
    users = data.get("response", {}).get("items", [])

print(f"üì¶ Found {len(users)} users to migrate")

# –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö UUID ‚Üí –Ω–æ–≤—ã—Ö UUID
uuid_mapping = {}

client = httpx.Client(
    base_url=NEW_PANEL,
    headers={"Authorization": f"Bearer {NEW_API_TOKEN}"},
    timeout=30.0
)

for user in users:
    old_uuid = user["uuid"]
    username = user["username"]
    telegram_id = user.get("telegramId")
    expire_at = user["expireAt"]
    traffic_limit = user.get("trafficLimitBytes")
    description = user.get("description", "")
    
    # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    try:
        payload = {
            "username": username,
            "expireAt": expire_at,
            "trafficLimitBytes": traffic_limit,
            "description": description,
        }
        
        if telegram_id:
            payload["telegramId"] = telegram_id
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ squads (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏)
        payload["externalSquadUuid"] = "your-external-squad-uuid"
        payload["activeInternalSquads"] = ["squad-1-uuid", "squad-2-uuid"]
        
        response = client.post("/api/users", json=payload)
        response.raise_for_status()
        
        new_user = response.json().get("response", response.json())
        new_uuid = new_user["uuid"]
        
        uuid_mapping[old_uuid] = new_uuid
        print(f"‚úÖ Migrated: {username} ({old_uuid} ‚Üí {new_uuid})")
        
    except Exception as e:
        print(f"‚ùå Failed to migrate {username}: {e}")

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–ø–ø–∏–Ω–≥ UUID
with open("uuid_mapping.json", "w") as f:
    json.dump(uuid_mapping, f, indent=2)

print(f"\n‚úÖ Migration complete! Migrated {len(uuid_mapping)} users")
print(f"üìÑ UUID mapping saved to uuid_mapping.json")
```

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ:**
```bash
python3 import_users.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∞–π–ª `uuid_mapping.json` —Å –º–∞–ø–ø–∏–Ω–≥–æ–º —Å—Ç–∞—Ä—ã—Ö UUID –Ω–∞ –Ω–æ–≤—ã–µ.

---

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UUID –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞

**–°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

```python
#!/usr/bin/env python3
# update_bot_database.py

import json
import sqlite3

DB_PATH = "data/bot_data.db"  # –ü—É—Ç—å –∫ –±–∞–∑–µ –±–æ—Ç–∞

# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ UUID
with open("uuid_mapping.json", "r") as f:
    uuid_mapping = json.load(f)

print(f"üì¶ Loaded {len(uuid_mapping)} UUID mappings")

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
conn = sqlite3.connect(DB_PATH)
cursor = conn.cursor()

updated = 0
not_found = 0

for old_uuid, new_uuid in uuid_mapping.items():
    # –û–±–Ω–æ–≤–ª—è–µ–º UUID –≤ —Ç–∞–±–ª–∏—Ü–µ bot_users
    cursor.execute(
        "UPDATE bot_users SET remnawave_user_uuid = ? WHERE remnawave_user_uuid = ?",
        (new_uuid, old_uuid)
    )
    
    if cursor.rowcount > 0:
        updated += 1
        print(f"‚úÖ Updated: {old_uuid} ‚Üí {new_uuid}")
    else:
        not_found += 1
        print(f"‚ö†Ô∏è Not found in bot DB: {old_uuid}")

conn.commit()
conn.close()

print(f"\n‚úÖ Database update complete!")
print(f"   Updated: {updated}")
print(f"   Not found: {not_found}")
```

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
# 1. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp uuid_mapping.json update_bot_database.py root@SERVER_IP:/opt/shftsecurebot/

# 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@SERVER_IP

# 3. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞
cd /opt/shftsecurebot

# 4. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –ë–î)
docker compose down

# 5. –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
cp data/bot_data.db data/bot_data.db.backup

# 6. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
python3 update_bot_database.py

# 7. –û–±–Ω–æ–≤–ª—è–µ–º .env (API_BASE_URL –Ω–∞ –Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å)
nano .env
# –ò–∑–º–µ–Ω–∏—Ç–µ: API_BASE_URL=https://panel.new-domain.com

# 8. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
docker compose up -d --build
```

---

### –®–∞–≥ 4: –ú–∞—Å—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤—Å–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥–∞—Ö:**

```python
# –î–æ–±–∞–≤—å—Ç–µ –≤ src/handlers/admin.py

@router.message(Command("migrate_notify"))
async def migrate_notify(message: Message):
    """–£–≤–µ–¥–æ–º–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å."""
    if message.from_user.id not in get_settings().admins:
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("""
        SELECT telegram_id, username 
        FROM bot_users 
        WHERE remnawave_user_uuid IS NOT NULL
    """)
    users = cursor.fetchall()
    conn.close()
    
    notification_text = (
        "üîî <b>–í–∞–∂–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!</b>\n\n"
        "–ú—ã –ø–µ—Ä–µ–Ω–µ—Å–ª–∏ –Ω–∞—à—É –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∞ –Ω–æ–≤—ã–µ, –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–µ —Å–µ—Ä–≤–µ—Ä—ã!\n\n"
        "üì• <b>–ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥:</b>\n"
        "1. –ù–∞–∂–º–∏—Ç–µ /start\n"
        "2. –í—ã–±–µ—Ä–∏—Ç–µ ¬´üîê –ú–æ–π –¥–æ—Å—Ç—É–ø¬ª\n"
        "3. –ù–∞–∂–º–∏—Ç–µ ¬´üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥¬ª\n\n"
        "‚ö°Ô∏è –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ, –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –±–æ–Ω—É—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n\n"
        "–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! üöÄ"
    )
    
    success = 0
    failed = 0
    
    for user in users:
        user_id = user['telegram_id']
        try:
            await message.bot.send_message(user_id, notification_text, parse_mode="HTML")
            success += 1
            await asyncio.sleep(0.05)  # –ó–∞–¥–µ—Ä–∂–∫–∞ 50ms –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        except Exception as e:
            failed += 1
            logger.warning(f"Failed to notify user {user_id}: {e}")
    
    await message.reply(
        f"‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n"
        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {success}\n"
        f"–û—à–∏–±–∫–∏: {failed}",
        parse_mode="HTML"
    )
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```
/migrate_notify
```

---

## üìù –í–∞—Ä–∏–∞–Ω—Ç B: –†—É—á–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)

–ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—â–µ:

### –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Remnawave –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–æ–¥—ã –∏ squads
3. –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π API —Ç–æ–∫–µ–Ω

---

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ .env –±–æ—Ç–∞

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–æ—Ç–∞
cd /opt/shftsecurebot
nano .env

# –ò–∑–º–µ–Ω–∏—Ç–µ:
API_BASE_URL=https://panel.new-domain.com
API_TOKEN=your_new_api_token

# –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ
docker compose down
docker compose up -d --build
```

---

### –®–∞–≥ 3: –°–±—Ä–æ—Å—å—Ç–µ UUID —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–æ—Ç–∞:**

```bash
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
docker compose down

# –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø –ë–î
cp data/bot_data.db data/bot_data.db.backup

# –°–±—Ä–∞—Å—ã–≤–∞–µ–º UUID (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–Ω–æ–≤–æ –ø–æ–ª—É—á–∞—Ç –¥–æ—Å—Ç—É–ø)
sqlite3 data/bot_data.db "UPDATE bot_users SET remnawave_user_uuid = NULL;"

# –ù–ï –°–ë–†–ê–°–´–í–ê–ï–ú trial_used –∏ loyalty_points - –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è!

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
docker compose up -d --build
```

---

### –®–∞–≥ 4: –í—ã–¥–∞–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –≤—Å–µ–º

**–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∞–¥–º–∏–Ω–∞:**

```python
# src/handlers/admin.py

@router.message(Command("grant_migration"))
async def grant_migration(message: Message):
    """–í—ã–¥–∞—Ç—å 30 –¥–Ω–µ–π –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏."""
    if message.from_user.id not in get_settings().admins:
        return
    
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT telegram_id, username FROM bot_users")
    users = cursor.fetchall()
    conn.close()
    
    settings = get_settings()
    granted = 0
    failed = 0
    
    for user in users:
        user_id = user['telegram_id']
        username = user['username'] or f"user_{user_id}"
        
        try:
            # –°–æ–∑–¥–∞—ë–º/–ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ 30 –¥–Ω–µ–π
            expire_date = (datetime.now() + timedelta(days=30)).isoformat() + "Z"
            
            user_data = await api_client.create_user(
                username=username,
                expire_at=expire_date,
                telegram_id=user_id,
                external_squad_uuid=settings.default_external_squad_uuid,
                active_internal_squads=settings.default_internal_squads,
            )
            
            user_uuid = user_data.get("response", {}).get("uuid")
            BotUser.set_remnawave_uuid(user_id, user_uuid)
            
            granted += 1
            logger.info(f"‚úÖ Granted 30 days to {username} (ID: {user_id})")
            
        except Exception as e:
            failed += 1
            logger.error(f"‚ùå Failed to grant to {username}: {e}")
    
    await message.reply(
        f"‚úÖ <b>–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n"
        f"–í—ã–¥–∞–Ω–æ 30 –¥–Ω–µ–π: {granted}\n"
        f"–û—à–∏–±–∫–∏: {failed}",
        parse_mode="HTML"
    )
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```
/grant_migration
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç **–Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –≤ –Ω–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –∏ –≤—ã–¥–∞—Å—Ç –≤—Å–µ–º 30 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ.

---

### –®–∞–≥ 5: –£–≤–µ–¥–æ–º–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```python
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /migrate_notify –∏–∑ –í–∞—Ä–∏–∞–Ω—Ç–∞ A
```

---

## üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –í–∞—Ä–∏–∞–Ω—Ç A (–ê–≤—Ç–æ–º–∞—Ç) | –í–∞—Ä–∏–∞–Ω—Ç B (–†—É—á–Ω–æ–π) |
|----------|---------------------|-------------------|
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è (—Å–∫—Ä–∏–ø—Ç—ã) | –ù–∏–∑–∫–∞—è |
| **–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã** | 2-4 —á–∞—Å–∞ | 30 –º–∏–Ω—É—Ç |
| **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** | –í—Å–µ –¥–∞–Ω–Ω—ã–µ (–¥–∞—Ç—ã, UUID) | –¢–æ–ª—å–∫–æ loyalty/trial |
| **–ü—Ä–æ—Å—Ç–æ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π | –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è |
| **–†–∏—Å–∫ –æ—à–∏–±–æ–∫** | –°—Ä–µ–¥–Ω–∏–π | –ù–∏–∑–∫–∏–π |
| **–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è** | >100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | <100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- [ ] –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –ø–∞–Ω–µ–ª—å Remnawave
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–æ–¥—ã –∏ squads
- [ ] –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π API —Ç–æ–∫–µ–Ω
- [ ] –°–¥–µ–ª–∞–Ω –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
- [ ] –°–¥–µ–ª–∞–Ω –±—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥–æ–≤ Caddy/Docker

### –í–∞—Ä–∏–∞–Ω—Ç A (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)
- [ ] –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ —Å—Ç–∞—Ä–æ–π –ø–∞–Ω–µ–ª–∏
- [ ] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å
- [ ] –°–æ–∑–¥–∞–Ω –º–∞–ø–ø–∏–Ω–≥ UUID (uuid_mapping.json)
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω—ã UUID –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω .env (API_BASE_URL, API_TOKEN)
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω Caddyfile (–µ—Å–ª–∏ –º–µ–Ω—è–µ—Ç—Å—è –¥–æ–º–µ–Ω)
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –±–æ—Ç –∏ Caddy
- [ ] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

### –í–∞—Ä–∏–∞–Ω—Ç B (–†—É—á–Ω–æ–π)
- [ ] –°–±—Ä–æ—à–µ–Ω—ã UUID –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω .env (API_BASE_URL, API_TOKEN)
- [ ] –í—ã–¥–∞–Ω—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤—Å–µ–º (/grant_migration)
- [ ] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (/migrate_notify)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤

### –ü—Ä–æ–≤–µ—Ä–∫–∞
- [ ] –ë–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] API –Ω–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –∫–æ–Ω—Ñ–∏–≥
- [ ] –ö–æ–Ω—Ñ–∏–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN)
- [ ] Mini App –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] –õ–æ–≥–∏ –±–æ—Ç–∞ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

---

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. UUID –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –≤ –ë–î –±–æ—Ç–∞

**–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞–ø–ø–∏–Ω–≥
cat uuid_mapping.json

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î
sqlite3 data/bot_data.db "SELECT telegram_id, remnawave_user_uuid FROM bot_users LIMIT 10;"

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ update_bot_database.py –∑–∞–Ω–æ–≤–æ
```

---

### 2. –ü–∞–Ω–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ "API error 400" –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ squads —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –Ω–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç `expireAt` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ISO 8601)

---

### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–°–∏–º–ø—Ç–æ–º:** "Failed to send notification: bot was blocked"

**–†–µ—à–µ–Ω–∏–µ:**
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ

---

## üöÄ –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤

```bash
# –õ–æ–≥–∏ –±–æ—Ç–∞
docker logs shftsecurebot-bot-1 -f

# –õ–æ–≥–∏ Caddy
docker logs caddy -f
```

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫

```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å UUID
sqlite3 data/bot_data.db "SELECT COUNT(*) FROM bot_users WHERE remnawave_user_uuid IS NOT NULL;"

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
curl -X GET "https://panel.new-domain.com/api/users?start=0&size=1" \
  -H "Authorization: Bearer $API_TOKEN" | jq '.response.totalCount'
```

---

### 3. –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–π –ø–∞–Ω–µ–ª–∏

**–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ –Ω–æ–≤—É—é!**

```bash
# –ù–∞ —Å—Ç–∞—Ä–æ–º —Å–µ—Ä–≤–µ—Ä–µ
docker compose down

# –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç
# –í Caddyfile —Å—Ç–∞—Ä–æ–π –ø–∞–Ω–µ–ª–∏:
panel.old-domain.com {
    redir https://panel.new-domain.com{uri} permanent
}
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:** `docker logs shftsecurebot-bot-1`
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î:** `sqlite3 data/bot_data.db "SELECT * FROM bot_users LIMIT 5;"`
3. **–û—Ç–∫–∞—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
   ```bash
   docker compose down
   cp data/bot_data.db.backup data/bot_data.db
   # –í–µ—Ä–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–π .env
   docker compose up -d
   ```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π** (–Ω–æ—á—å/—Ä–∞–Ω–Ω–µ–µ —É—Ç—Ä–æ)
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ** –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π
3. **–°–¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø—ã –≤—Å–µ–≥–æ** (–ë–î, .env, –∫–æ–Ω—Ñ–∏–≥–∏)
4. **–î–µ—Ä–∂–∏—Ç–µ —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞—é—â–µ–π** –ø–µ—Ä–≤—ã–µ 24-48 —á–∞—Å–æ–≤
5. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏** –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

---

**–ì–æ—Ç–æ–≤–æ!** üéâ

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å Remnawave.

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å! üòä

